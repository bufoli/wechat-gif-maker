# 云开发配置指南

## 一、开启云开发服务

### 1. 在小程序管理后台开启云开发

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入你的小程序管理后台
3. 点击左侧菜单「开发」→「云开发」
4. 点击「开通」按钮
5. 选择「按量付费」或「包年包月」（建议先选择按量付费）
6. 创建云开发环境（环境名称可以自定义，如 `gif-maker`）

### 2. 获取环境ID

创建环境后，会得到一个环境ID（类似：`cloud1-xxxxx`），记下这个ID。

### 3. 在代码中配置环境ID

打开 `app.js`，修改云开发初始化代码：

```javascript
wx.cloud.init({
  env: '你的环境ID', // 替换为你的环境ID
  traceUser: true
})
```

## 二、创建视频抽帧云函数

### 1. 在微信开发者工具中创建云函数

1. 在微信开发者工具中，点击顶部菜单「云开发」
2. 点击「云函数」标签
3. 点击「新建云函数」
4. 输入函数名称：`videoResample`
5. 选择运行环境：Node.js
6. 点击「确定」

### 2. 上传云函数代码

云函数创建后，会在项目根目录生成 `cloud/videoResample/` 文件夹。

将以下文件内容复制到对应位置：

**cloud/videoResample/index.js** - 已创建，包含云函数代码
**cloud/videoResample/package.json** - 已创建，包含依赖配置

### 3. 安装依赖

在 `cloud/videoResample/` 目录下，需要安装以下依赖：

```bash
npm install wx-server-sdk
```

**注意**：视频处理需要FFmpeg，但云函数环境默认不包含FFmpeg。有以下方案：

#### 方案A：使用自定义运行环境（推荐）

1. 在云函数目录创建 `Dockerfile`：
```dockerfile
FROM node:16
RUN apt-get update && apt-get install -y ffmpeg
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
CMD ["node", "index.js"]
```

2. 在云开发控制台配置自定义运行环境

#### 方案B：使用第三方服务（简化方案）

如果无法配置FFmpeg，可以考虑：
- 使用第三方视频处理API（如七牛云、阿里云等）
- 或者提示用户视频已自动处理，实际在导出GIF时再处理

### 4. 上传并部署云函数

1. 在微信开发者工具中，右键点击 `cloud/videoResample` 文件夹
2. 选择「上传并部署：云端安装依赖」
3. 等待部署完成

## 三、测试云函数

### 1. 在云开发控制台测试

1. 进入云开发控制台
2. 点击「云函数」→「videoResample」
3. 点击「测试」标签
4. 输入测试参数：
```json
{
  "videoPath": "测试视频路径",
  "fps": 12
}
```
5. 点击「测试」按钮

### 2. 在小程序中测试

1. 重新编译小程序
2. 上传一个视频
3. 查看控制台日志，确认云函数是否被调用
4. 如果成功，视频会自动抽帧为12fps

## 四、常见问题

### Q1: 云函数调用失败，提示"not found"
**A**: 检查云函数是否已上传并部署。在云开发控制台确认函数存在。

### Q2: 视频处理失败
**A**: 
- 检查FFmpeg是否已正确配置
- 检查视频格式是否支持
- 查看云函数日志，定位具体错误

### Q3: 处理时间过长
**A**: 
- 云函数有执行时间限制（默认3秒，可配置到60秒）
- 对于长视频，建议分段处理
- 或者使用异步处理，通过云数据库存储任务状态

### Q4: 费用问题
**A**: 
- 云开发按量付费，视频处理会消耗资源
- 建议设置费用预警
- 可以在云开发控制台查看使用量和费用

## 五、简化方案（如果不想配置云函数）

如果暂时不想配置云开发，可以：

1. **跳过自动抽帧**：直接使用原始视频，在导出GIF时再处理
2. **使用第三方服务**：集成第三方视频处理API
3. **客户端处理**：使用Canvas API逐帧处理（性能有限，仅适合短视频）

修改 `pages/index/index.js`，注释掉抽帧相关代码即可。
