<!--pages/video-text/video-text.wxml-->
<wxs module="utils" src="../video-edit/utils.wxs"></wxs>
<view class="container">
  <!-- 视频预览区域 -->
  <view class="preview-section">
    <view class="preview-wrapper">
      <video 
        id="videoPlayer"
        src="{{videoPath}}" 
        class="video-player"
        controls="{{false}}"
        show-center-play-btn="{{true}}"
        enable-play-gesture="{{true}}"
        object-fit="contain"
        bindtimeupdate="onVideoTimeUpdate"
        bindplay="onVideoPlay"
        bindpause="onVideoPause"
        bindended="onVideoEnded"
        binderror="onVideoError"
        bindloadedmetadata="onVideoLoadedMetadata"
      ></video>
      
      <!-- 文字叠加层 -->
      <view class="text-overlay">
        <view 
          class="text-item {{currentTextIndex === index ? 'active' : ''}}"
          wx:for="{{texts}}" 
          wx:key="id"
          data-index="{{index}}"
          style="left: {{item.x}}rpx; top: {{item.y}}rpx; font-size: {{item.fontSize}}rpx; color: {{item.color}}; font-family: {{item.fontFamily}}; transform: scale({{item.scale || 1}}) rotate({{item.rotate || 0}}deg); transform-origin: center center;"
          bindtouchstart="onTextTouchStart"
          bindtouchmove="onTextTouchMove"
          bindtouchend="onTextTouchEnd"
        >
          <view class="text-content">{{item.content}}</view>
          <view wx:if="{{currentTextIndex === index}}" class="text-controls">
            <view class="text-control-btn" bindtap="copyText" data-index="{{index}}">复制</view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- iOS风格时间轴组件 -->
  <view class="timeline-section">
    <view class="timeline-container">
      <!-- 播放按钮 -->
      <view class="play-btn-wrapper">
        <view class="play-btn {{isPlaying ? 'playing' : ''}}" bindtap="togglePlay">
          <view class="play-icon-triangle" wx:if="{{!isPlaying}}"></view>
          <view class="play-icon-pause" wx:else>
            <view class="pause-line"></view>
            <view class="pause-line"></view>
          </view>
        </view>
      </view>
      
      <!-- 时间轴 -->
      <view class="timeline-wrapper">
        <view 
          class="timeline-track" 
          bindtouchstart="onTimelineTouchStart" 
          bindtouchmove="onTimelineTouchMove" 
          bindtouchend="onTimelineTouchEnd"
        >
          <!-- 背景进度条 -->
          <view class="timeline-bg">
            <view class="timeline-progress" style="width: {{(currentTime / videoDuration) * 100}}%"></view>
          </view>
          
          <!-- 选择框 -->
          <view 
            class="timeline-selection" 
            style="left: {{(trimStart / videoDuration) * 100}}%; width: {{((trimEnd - trimStart) / videoDuration) * 100}}%"
          >
            <!-- 开始拖拽手柄 -->
            <view 
              class="timeline-handle timeline-handle-start"
              data-type="start"
              bindtouchstart="onHandleTouchStart"
              bindtouchmove="onHandleTouchMove"
              bindtouchend="onHandleTouchEnd"
            ></view>
            
            <!-- 结束拖拽手柄 -->
            <view 
              class="timeline-handle timeline-handle-end"
              data-type="end"
              bindtouchstart="onHandleTouchStart"
              bindtouchmove="onHandleTouchMove"
              bindtouchend="onHandleTouchEnd"
            ></view>
          </view>
          
          <!-- 当前播放位置指示器 -->
          <view 
            class="timeline-indicator" 
            style="left: {{(currentTime / videoDuration) * 100}}%"
            wx:if="{{isPlaying}}"
          ></view>
        </view>
        
        <!-- 时间标签 -->
        <view class="timeline-labels">
          <text class="time-label">{{utils.toFixed(trimStart, 1)}}s</text>
          <text class="time-label">{{utils.toFixed(trimEnd, 1)}}s</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 文字编辑工具栏 -->
  <view class="text-toolbar">
    <view class="text-input-section">
      <input class="text-input" value="{{editingText}}" placeholder="请输入文字" bindinput="onTextInput" />
    </view>
    <view class="font-selector">
      <view 
        class="font-item {{selectedFont === item.value ? 'active' : ''}}"
        wx:for="{{fonts}}" 
        wx:key="value"
        data-font="{{item.value}}"
        bindtap="selectFont"
        style="font-family: {{item.value}};"
      >
        {{item.name}}
      </view>
    </view>
    <view class="text-toolbar-actions">
      <button class="text-confirm-btn" bindtap="confirmAddText">{{isTextEditing ? '保存' : '确认'}}</button>
    </view>
  </view>
</view>
